def apiDir = "$buildDir/api"
def apiProject = parent.childProjects.'edge-core-api'

import javassist.*

def _generator = { CtClass c ->
  def placeholder = '_lang_'
  def lang = 'groovy'

  println c.name
  c.declaredBehaviors.each { CtBehavior method ->
    def info = method.methodInfo
    println "Method: $info.descriptor"
    info.descriptor = info.descriptor.replace(placeholder, lang)
  }

  c.declaredFields.each { CtField field ->
    def info = field.fieldInfo
    println "Field: $info.descriptor"
    info.descriptor = info.descriptor.replace(placeholder, lang)
  }
  
  c.name = c.name.replace(placeholder, lang)
}

task('generateGroovy', type: com.darylteo.gradle.codegen.tasks.GenerateSources) {
  dependsOn apiProject.classes
  from apiProject
  generator = _generator
}
task getApi(type: Sync) {
  from generateGroovy
  into file(apiDir)
}

sourceSets {
  main {
    compileClasspath += files(apiDir) { builtBy getApi }
  }
}

modZip { from apiDir }

jar { from apiDir }